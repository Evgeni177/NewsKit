const fse = require('fs-extra');
const filledIcons = require('./filled-icons-list');
const outlinedIcons = require('./outlined-icons-list');
const {usedIcons} = require('./used-icons-list');

const warning =
  '// This file is automatically generated do not modify it. See scripts/generate-icons/index.js';

const toKebabCase = str =>
  str
    .match(/[A-Z]{2,}(?=[A-Z][a-z0-9]*|\b)|[A-Z]?[a-z0-9]*|[A-Z]|[0-9]+/g)
    .filter(Boolean)
    .map(x => x.toLowerCase())
    .join('-');

const toFileData = (iconSet, iconName) => {
  const componentName = iconSet + iconName;
  const fileName = toKebabCase(componentName);
  const fileBody = `${warning}
import {${iconName}} from '@emotion-icons/material/${iconName}';
import {toNewsKitIcon} from '../../to-newskit-icon';

// The updated display name will be used to return the right icon in
// "to-newskit-icon.tsx", if it gets overridden
${iconName}['displayName'] = "${componentName}";

export const ${componentName} = toNewsKitIcon(${iconName});
`;
  return {fileName, fileBody, componentName};
};

const toExportStatement = file =>
  `export {${file.componentName}} from './${file.fileName}';`;

const wipeFolder = iconSubfolder => {
  fse.emptyDirSync(`./src/icons/${iconSubfolder}`, {recursive: true});
};

const generateIconFiles = (filesData, iconSubfolder) => {
  const iconsDirectory = './src/icons/';
  filesData.forEach(data =>
    fse.writeFile(
      `${iconsDirectory + iconSubfolder}/${data.fileName}.tsx`,
      data.fileBody,
      // eslint-disable-next-line
      err => err && console.error(err),
    ),
  );
};

const generateIndexFile = (filesData, iconSubfolder) => {
  const exportBody = [warning, ...filesData.map(toExportStatement)].join('\n');
  fse.writeFile(
    `./src/icons/${iconSubfolder}/index.ts`,
    exportBody,
    // eslint-disable-next-line
    err => err && console.error(err),
  );
};

const generateFiles = (icons, iconSubfolder, namingPrefix = 'Icon') => {
  const filesData = icons.map(iconName => toFileData(namingPrefix, iconName));
  wipeFolder(iconSubfolder);
  generateIconFiles(filesData, iconSubfolder);
  generateIndexFile(filesData, iconSubfolder);
};

const generateIcons = env => {
  if (env === 'ci') {
    generateFiles(filledIcons, 'filled/material', 'IconFilled');
    generateFiles(outlinedIcons, 'outlined/material', 'IconOutlined');
  } else if (env === 'dev') {
    generateFiles(usedIcons, 'filled/material', 'IconFilled');
    generateFiles(usedIcons, 'outlined/material', 'IconOutlined');
  }
};

generateIcons(process.argv[2].replace('--', ''));
